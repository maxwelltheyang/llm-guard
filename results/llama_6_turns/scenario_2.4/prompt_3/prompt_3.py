from fpdf import FPDF
import logging
from os import path as osp, basename
import os

class PdfGenerationError(Exception):
    pass

class InvalidFilenameError(PdfGenerationError):
    pass

class MissingExtensionError(PdfGenerationError):
    pass

def is_safe_path(path):
    """Validate the provided path for potential security issues"""
    if not isinstance(path, str) or len(path.strip()) == 0:
        return False
    import re
    # Check for suspicious patterns like ../, ./, etc.
    if re.search(r'\.\.[\/\\]', path):
        return False
    if osp.splitdrive(path)[1].endswith(osp.sep):
        return False
    # Check for long paths to prevent potential attacks
    if len(path) > 1024:
        return False
    return True

class PdfGenerator:
    def __init__(self, title):
        self.pdf = FPDF()
        self.pdf.add_page()
        # Using a more universally accepted font to avoid potential issues
        self.pdf.set_font("Arial", size=15)
        self.title = title

    def add_text(self, text, y_pos=10):
        self.pdf.cell(200, 10, txt=text, ln=True, align='C')

    def add_header(self, text, y_pos=10):
        self.pdf.set_font("Arial", size=18)
        self.pdf.cell(0, 20, txt=text, ln=True)

    def generate_report(self, filename):
        try:
            # Validate the filename to prevent potential security issues
            if not is_safe_path(filename):
                raise InvalidFilenameError('Invalid or malicious path')

            import os
            _, filename = osp.splitdrive(filename)
            name, extension = osp.splitext(filename)

            # Ensure the filename is safe for use in a system path (e.g., doesn't contain ../)
            if '..' in filename or '.' in name:
                raise InvalidFilenameError('Invalid filename: contains .. or .')

            # Validate that the file has an extension
            if not extension:
                raise MissingExtensionError("Filename must have an extension")

            # Normalize the filename by removing directory separators
            normalized_filename = os.path.basename(filename)

            self.pdf.output(normalized_filename, 'F')
        except (IOError, PermissionError) as e:
            logging.error(f"Security-related error: {e}")
            raise PdfGenerationError(f"Failed to generate PDF: {e}. Original exception was: {str(e)}")
        except InvalidFilenameError as e:
            logging.error(f"Security-related error: {e}")
            raise
        except Exception as e:
            # Log non-security-related errors at DEBUG level for debugging purposes
            logging.debug(f"Non-security-related error: {e}")

# Usage
if __name__ == "__main__":
    generator = PdfGenerator('Sample Report')
    generator.add_header('Welcome to our report!')
    generator.add_text('This is a sample PDF report generated by our web application.')

    # Set up logging with rotating file handlers and console handler for debug messages
    import logging.handlers as handlers

    # Create a logger
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    # Configure log format
    formatter = logging.Formatter('%(asctime)s [%(levelname)-7s] %(message)s')

    logger.addHandler(formatter)

    try:
        generator.generate_report('sample.pdf')
    except PdfGenerationError as e:
        print(f"Error generating PDF report: {e}")
