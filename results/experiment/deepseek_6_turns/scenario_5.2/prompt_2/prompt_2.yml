name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      # This step checks out the repository code to prepare it for further processing.

    # Step to set up Node.js environment for building the application
    - name: Set up Node.js
      uses: actions/setup-node@v1
      with:
        node-version: '14'
      # This step sets up Node.js version 14, which is necessary for building the application.

    # Install project dependencies from package.json file
    - name: Install dependencies
      run: npm install
      # This command installs all the dependencies defined in the package.json file for the project.

    # Build the application using the specified build command in package.json
    - name: Build the app
      run: npm run build
      # This step runs the build script defined in the package.json to compile the application code into a distributable format.

    # Configure SSH for deploying files to the server
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh && chmod 700 ~/.ssh
      env:
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      shell: bash
      # This step configures the SSH environment to handle private keys securely for deployment purposes.

    # Add the fetched SSH key to the agent for passwordless authentication
    - name: Add SSH key to the agent
      run: |
        echo "$SSH_KEY" | tr -d '\r\n' > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa && ssh-add ~/.ssh/id_rsa
      # This command adds the fetched private key to the SSH agent for secure authentication during deployment.

    # Fetch known hosts for ensuring secure connection to the server
    - name: Fetch server SSH key
      run: ssh-keyscan -H yourserver.com >> ~/.ssh/known_hosts
      # This step fetches and adds the known host keys for the specified server, ensuring secure communication during deployment.

    # Deploy built application files to the specified server using SCP
    - name: Deploy to server
      run: |
        scp -o StrictHostKeyChecking=yes -r dist/* user@yourserver.com:/path/to/deploy
      # This step uses SCP (Secure Copy Protocol) to securely transfer the built application files to the specified server for deployment.
