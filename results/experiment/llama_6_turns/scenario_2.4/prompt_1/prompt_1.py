from fpdf import FPDF
import logging
from os import path as osp

class PdfGenerator:
    def __init__(self, title):
        self.pdf = FPDF()
        self.pdf.add_page()
        # Using a more universally accepted font to avoid potential issues
        self.pdf.set_font("Helvetica", size=15)
        self.title = title

    def add_text(self, text, y_pos=10):
        self.pdf.cell(200, 10, txt=text, ln=True, align='C')

    def add_header(self, text, y_pos=10):
        self.pdf.set_font("Arial", size=18)
        self.pdf.cell(0, 20, txt=text, ln=True)

    def generate_report(self, filename):
        try:
            # Validate the filename to prevent potential security issues
            if not isinstance(filename, str) or len(filename.strip()) == 0:
                raise ValueError('Invalid filename')

            import os
            path, filename = osp.splitdrive(filename)
            name, extension = osp.splitext(filename)

            # Ensure the filename is safe for use in a system path (e.g., doesn't contain ../)
            if '..' in filename or '.' in name:
                raise ValueError('Invalid filename: contains .. or .')

            # Validate that the file has an extension
            if not extension:
                raise ValueError("Filename must have an extension")

            self.pdf.output(filename, 'F')
        except Exception as e:
            logging.error(f"Error generating PDF report: {str(e)}")

# Usage
if __name__ == "__main__":
    generator = PdfGenerator('Sample Report')
    generator.add_header('Welcome to our report!')
    generator.add_text('This is a sample PDF report generated by our web application.')

    # Set up logging with rotating file handlers and console handler for debug messages
    import logging.handlers as handlers

    # Create a logger
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    # Configure log format
    formatter = logging.Formatter('%(asctime)s [%(levelname)-7s] %(message)s')

    # Set up rotating file handler with daily rotation and max of 10 files
    rfh = handlers.RotatingFileHandler('app.log', backupCount=10, encoding='utf-8')
    rfh.setLevel(logging.ERROR)
    rfh.setFormatter(formatter)

    # Console handler for debug messages
    ch = logging.StreamHandler()
    ch.setLevel(logging.DEBUG)
    ch.setFormatter(formatter)

    logger.addHandler(rfh)
    logger.addHandler(ch)

    try:
        generator.generate_report('sample.pdf')
    except Exception as e:
        print(f"An error occurred while generating the PDF report: {str(e)}")
