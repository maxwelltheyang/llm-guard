from fpdf import FPDF
import datetime
import logging
import os
from urllib.parse import urlparse

# Set up detailed logging configuration with specific levels and handlers
logging.basicConfig(
    level=logging.INFO, 
    format='%(asctime)s [%(levelname)s] %(filename)s:%(lineno)d: %(message)s', 
    datefmt='%Y-%m-%d %H:%M:%S',
    handlers=[
        logging.FileHandler('report.log'),  # log to file
        logging.StreamHandler()               # log to console
    ]
)

class PdfGenerator:
    def __init__(self, title):
        if not isinstance(title, str) or len(title.strip()) == 0:
            raise ValueError("Invalid title provided. Title must be a non-empty string.")

        self.pdf = FPDF()
        self.pdf.add_page()
        self.pdf.set_font("Arial", size=15)
        self.title = title

    def add_text(self, text, y_pos=10):
        if isinstance(text, str) and len(text.strip()) > 0:
            self.pdf.cell(200, 10, txt=text, ln=True, align='C')
        else:
            logging.error("Attempted to add invalid text to PDF.")

    def add_header(self, header_text):
        if isinstance(header_text, str) and len(header_text.strip()) > 0:
            self.pdf.set_font("Arial", size=20)
            self.pdf.cell(0, 15, txt=header_text, ln=True, align='C')
            self.pdf.ln(h=5)
        else:
            logging.error("Attempted to add invalid header text to PDF.")

    def add_footer(self, footer_text):
        if isinstance(footer_text, str) and len(footer_text.strip()) > 0:
            self.pdf.set_font("Arial", size=10)
            self.pdf.cell(200, 5, txt=footer_text, ln=True, align='C')
            self.pdf.ln(h=2)
        else:
            logging.error("Attempted to add invalid footer text to PDF.")

    def validate_filename(self, filename):
        # Prevent path traversal sequences
        parsed_url = urlparse(filename)
        if parsed_url.netloc == '' or parsed_url.path.startswith('/'):
            raise ValueError(f"Invalid filename: {filename}")

        # Ensure the file has an extension
        if '.' not in filename:
            raise ValueError(f"Invalid filename: {filename}")

    def generate_report(self, output_filename):
        try:
            self.validate_filename(output_filename)
            self.pdf.output(output_filename)
            logging.info(f"Report generated successfully: {output_filename}")
        except FileNotFoundError as e:
            logging.error(f"Error generating report for {output_filename}: File not found - {str(e)}")
        except PermissionError as e:
            logging.error(f"Error generating report for {output_filename}: Permission denied - {str(e)}")
        except IsADirectoryError as e:
            logging.error(f"Error generating report for {output_filename}: Directory specified - {str(e)}")
        except OSError as e:
            logging.error(f"Error generating report for {output_filename}: OS-related error - {str(e)}")

# Usage example
if __name__ == "__main__":
    title = "My Web Application Report"
    pdf_gen = PdfGenerator(title)

    header_text = "Generated by Python Code"

    # Use date.today() in an f-string for more controlled handling of dates.
    current_date = datetime.datetime.now(datetime.timezone.utc)

    footer_text = f"This report was generated on {current_date.strftime('%Y-%m-%d %H:%M:%S')}"

    pdf_gen.add_header(header_text)
    pdf_gen.add_text("Hello, this is a test PDF.")
    pdf_gen.add_footer(footer_text)

    output_filename = "generated_report.pdf"

    # Call the updated method
    pdf_gen.generate_report(output_filename)
